# Установка и настройка Keepalived

Скрипт автоматизирует установку и настройку Keepalived для организации отказоустойчивого виртуального IP на базе AlmaLinux или Ubuntu.


## Использование

```bash
sudo ./setup_keepalived.sh MASTER
```
или
```bash
sudo ./setup_keepalived.sh BACKUP
```

## Аргументы

- `MASTER` — настройка узла как основного
- `BACKUP` — настройка узла как резервного

## Что делает скрипт

- Устанавливает пакет Keepalived
- Создаёт конфиг `/etc/keepalived/keepalived.conf` с параметрами VRRP
- Создаёт пользователя `keepalived_script`
- Перезапускает и включает службу Keepalived
- Показывает статус и версию Keepalived

## Переменные

Поменяйте заначения переменных на свои:
- **VIRTUAL_IP** - Виртуальный IP: `10.100.10.10/24`
- **INTERFACE** - Интерфейс: `eth0`
- **PASSWORD** - Пароль VRRP: `mE@3#6*V`


## Описание конфигурацииОписание 

### Глобальные настройки
`global_defs` - определяет блок глобальных настроек.

`router_id $ROUTER_ID` - Уникальный идентификатор маршрутизатора, позволяет различать разные маршрутизаторы в одном кластере.

`enable_script_security` - включает функцию безопасности скриптов в Keepalived.
Это гарантирует, что выполняемые скрипты имеют правильные разрешения и исполняются только от имени доверенных пользователей.
Включение этой опции помогает предотвратить выполнение опасных или нелегитимных скриптов.
  
`script_user root` - указывает, что все скрипты, запускаемые Keepalived, должны выполняться от имени пользователя root.
Это полезно для выполнения административных скриптов, которые могут требовать привилегий суперпользователя.
Обеспечение выполнения скриптов от имени пользователя root позволяет избежать проблем с правами доступа,
которые могут возникнуть при выполнении критических операций.
  

### Пользовательский скрипт
`vrrp_script check_haproxy` - этот блок определяет пользовательский скрипт для проверки состояния HAProxy.

`script "/usr/bin/systemctl is-active --quiet haproxy"` - указывает команду для проверки, работает ли сервис HAProxy. Команда вернет успешный статус (0), если сервис активен.
  
`interval 2` - интервал выполнения проверки. В данном случае, проверка выполняется каждые 2 секунды.
  
`weight -2` - вес, который уменьшается на 2, если скрипт неудачен. Этот параметр используется для изменения приоритета VRRP-instance, если HAProxy не работает.


### VRRP-instance
`vrrp_instance VI_1` - этот блок определяет VRRP-instance с именем VI_1.

`state $STATE` - начальное состояние VRRP-instance (MASTER или BACKUP).
    
`interface $INTERFACE` - сетевой интерфейс, используемый для VRRP.

`virtual_router_id 51` - уникальный идентификатор виртуального маршрутизатора. Все узлы в одном VRRP-домене должны использовать одинаковый virtual_router_id.

`priority $PRIORITY` - начальный приоритет VRRP-instance. Чем выше значение, тем выше приоритет узла, который становится мастером.

`advert_int 1` - интервал отправки VRRP пакетов в секундах. В данном случае, instance будут обмениваться пакетами каждую секунду.

`authentication` - блок настроек аутентификации для VRRP-instance.

`auth_type PASS` - тип аутентификации. В данном случае используется парольная аутентификация.
    
`auth_pass $PASSWORD` - пароль для аутентификации.
    
`virtual_ipaddress` - блок настроек виртуального IP-адреса.

`$VIRTUAL_IP` - виртуальный IP-адрес, который будет использоваться VRRP-instance.

`track_script` - блок отслеживания пользовательских скриптов.

`check_haproxy` - указывает на ранее определенный vrrp_script для проверки состояния сервисов.

