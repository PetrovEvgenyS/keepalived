# Установка и настройка Keepalived для отказоустойчивости HAProxy

Скрипт автоматизирует установку и настройку Keepalived для организации отказоустойчивого виртуального IP-адреса, обеспечивая высокую доступность HAProxy на серверах под управлением AlmaLinux или Ubuntu.

## Назначение

Скрипт предназначен для настройки кластера из двух серверов (MASTER и BACKUP), между которыми осуществляется автоматическое переключение виртуального IP-адреса в случае сбоя HAProxy или одного из серверов. Это позволяет обеспечить непрерывную работу HAProxy и повысить отказоустойчивость сервисов.

## Примечания

- Скрипт не устанавливает и не настраивает HAProxy — он только следит за его состоянием.
- Для корректной работы убедитесь, что HAProxy установлен и настроен на обоих узлах.

## Требования

- AlmaLinux или Ubuntu (скрипт автоматически определяет ОС)
- Права суперпользователя (запуск через `sudo`)
- Установленный HAProxy (скрипт отслеживает его состояние)

## Использование

```bash
sudo ./setup_keepalived.sh MASTER
```
или
```bash
sudo ./setup_keepalived.sh BACKUP
```

## Аргументы

- `MASTER` — настройка узла как основного
- `BACKUP` — настройка узла как резервного

## Что делает скрипт

- Определяет ОС и устанавливает пакет Keepalived
- Создаёт и настраивает конфиг `/etc/keepalived/keepalived.conf` с параметрами VRRP для отслеживания состояния HAProxy
- Создаёт пользователя `keepalived_script` (для безопасности)
- Перезапускает и включает службу Keepalived
- Показывает статус и версию Keepalived

## Переменные (проверьте и измените при необходимости)

- **VIRTUAL_IP** — виртуальный IP-адрес, например: `10.100.10.10/24`
- **INTERFACE** — сетевой интерфейс, например: `eth0`
- **PASSWORD** — пароль VRRP, например: `mE@3#6*V`


## Описание конфигурации

### Глобальные настройки
`global_defs` - определяет блок глобальных настроек.

`router_id $ROUTER_ID` - Уникальный идентификатор маршрутизатора, позволяет различать разные маршрутизаторы в одном кластере.

`enable_script_security` - включает функцию безопасности скриптов в Keepalived.
Это гарантирует, что выполняемые скрипты имеют правильные разрешения и исполняются только от имени доверенных пользователей.
Включение этой опции помогает предотвратить выполнение опасных или нелегитимных скриптов.
  
`script_user keepalived_script` - указывает, что все скрипты, запускаемые Keepalived, должны выполняться от имени пользователя keepalived_script.
Это полезно для повышения безопасности: пользователь keepalived_script не имеет административных прав и не может выполнять критические операции вне нужных скриптов.
Обеспечение выполнения скриптов от имени отдельного пользователя позволяет ограничить потенциальный ущерб при компрометации скрипта.


### Пользовательский скрипт
`vrrp_script check_haproxy` - этот блок определяет пользовательский скрипт для проверки состояния HAProxy.

`script "/usr/bin/systemctl is-active --quiet haproxy"` - указывает команду для проверки, работает ли сервис HAProxy. Команда вернет успешный статус (0), если сервис активен.
  
`interval 2` - интервал выполнения проверки. В данном случае, проверка выполняется каждые 2 секунды.
  
`weight -2` - вес, который уменьшается на 2, если скрипт неудачен. Этот параметр используется для изменения приоритета VRRP-instance, если HAProxy не работает.


### VRRP-instance
`vrrp_instance VI_1` - этот блок определяет VRRP-instance с именем VI_1.

`state $STATE` - начальное состояние VRRP-instance (MASTER или BACKUP).
    
`interface $INTERFACE` - сетевой интерфейс, используемый для VRRP.

`virtual_router_id 51` - уникальный идентификатор виртуального маршрутизатора. Все узлы в одном VRRP-домене должны использовать одинаковый virtual_router_id.

`priority $PRIORITY` - начальный приоритет VRRP-instance. Чем выше значение, тем выше приоритет узла, который становится мастером.

`advert_int 1` - интервал отправки VRRP пакетов в секундах. В данном случае, instance будут обмениваться пакетами каждую секунду.

`authentication` - блок настроек аутентификации для VRRP-instance.

`auth_type PASS` - тип аутентификации. В данном случае используется парольная аутентификация.
    
`auth_pass $PASSWORD` - пароль для аутентификации.
    
`virtual_ipaddress` - блок настроек виртуального IP-адреса.

`$VIRTUAL_IP` - виртуальный IP-адрес, который будет использоваться VRRP-instance.

`track_script` - блок отслеживания пользовательских скриптов.

`check_haproxy` - указывает на ранее определенный vrrp_script для проверки состояния сервисов.

